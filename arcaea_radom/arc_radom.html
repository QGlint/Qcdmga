<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Arcaea 随机抽歌</title>
<style>
body {
    margin:0;
    font-family: Arial, sans-serif;
}
.header {
    position: fixed;
    top:0;
    left:0;
    width:100%;
    background:#f0f0f0;
    border-bottom:1px solid #ccc;
    display:flex;
    height:200px;
    overflow:auto;
    padding:5px;
    box-sizing:border-box;
}
.accordion {
    flex:1;
    border:1px solid #ccc;
    margin:0 5px;
    border-radius:4px;
    overflow:auto;
}
.accordion h3 {
    margin:0;
    background:#ddd;
    padding:5px;
    cursor:pointer;
}
.accordion .content {
    padding:5px;
}
.accordion label {
    display:block;
}
#main {
    margin-top:210px;
    padding:10px;
}
.song-card {
    border:1px solid #ccc;
    padding:5px;
    margin-bottom:10px;
    display:flex;
    flex-direction:column;
    width:150px;
}
.song-card img {
    width:100%;
    height:auto;
}
.song-card div {
    margin-top:3px;
}
button {
    margin:5px;
    padding:5px 10px;
}
</style>
</head>
<body>

<div class="header">
    <div class="accordion" id="packAccordion">
        <h3>曲包</h3>
        <div class="content" id="packContainer"></div>
    </div>
    <div class="accordion" id="diffAccordion">
        <h3>难度类型</h3>
        <div class="content" id="diffContainer"></div>
    </div>
    <div class="accordion" id="diffValAccordion">
        <h3>难度值</h3>
        <div class="content" id="diffValContainer"></div>
    </div>
</div>

<div id="main">
    <label>抽取数量: <input type="number" id="numInput" value="5" min="1"></label>
    <button onclick="drawSongs()">抽歌</button>
    <div id="resultContainer" style="display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;"></div>
</div>

<script>
// ==================== 数据加载 ====================
let songs = [], packs = [], diffTypes = ["PST","PRS","FTR","ETR","BYD"], diffVals = [];

async function loadData(){
    songs = await (await fetch('arc_songs.json')).json();
    packs = await (await fetch('arc_packs.json')).json();
    // 初始化难度值集合
    let valSet = new Set();
    songs.forEach(s=>{
        diffTypes.forEach(d=>{
            if(s.difficulties[d]!=='/'){
                valSet.add(s.difficulties[d]);
            }
        });
    });
    diffVals = Array.from(valSet).sort((a,b)=>{
    const numA = parseFloat(a);
    const numB = parseFloat(b);
    if(numA !== numB) return numA - numB;
    // 同一个数字，带 '+' 的排后面
    if(a.includes('+') && !b.includes('+')) return 1;
    if(!a.includes('+') && b.includes('+')) return -1;
    return 0;
});
    initCheckboxes();
}

// ==================== 生成选择框 ====================
function createCheckbox(name, containerId){
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    const allLabel = document.createElement('label');
    const allInput = document.createElement('input');
    allInput.type='checkbox';
    allInput.value='全选';
    allInput.checked=true;
    allInput.addEventListener('change',()=>toggleAll(containerId, allInput));
    allLabel.appendChild(allInput);
    allLabel.appendChild(document.createTextNode('全选'));
    container.appendChild(allLabel);

    name.forEach(n=>{
        const label = document.createElement('label');
        const input = document.createElement('input');
        input.type='checkbox';
        input.value=n;
        input.checked=true;
        input.addEventListener('change',()=>childChanged(containerId));
        label.appendChild(input);
        label.appendChild(document.createTextNode(n));
        container.appendChild(label);
    });
}

function toggleAll(containerId, allInput){
    const container = document.getElementById(containerId);
    container.querySelectorAll('input[type=checkbox]').forEach(cb=>{
        if(cb.value!=='全选') cb.checked = allInput.checked;
    });
}

function childChanged(containerId){
    const container = document.getElementById(containerId);
    const allInput = container.querySelector('input[value="全选"]');
    const children = Array.from(container.querySelectorAll('input[type=checkbox]')).filter(cb=>cb.value!=='全选');
    if(children.every(cb=>cb.checked)) allInput.checked=true;
    else allInput.checked=false;
}

// ==================== 抽歌逻辑 ====================
function shuffle(arr){return arr.sort(()=>Math.random()-0.5);}

function drawSongs(){
    const num = parseInt(document.getElementById('numInput').value);
    const selectedPacks = Array.from(document.querySelectorAll('#packContainer input:checked'))
        .map(cb=>cb.value).filter(v=>v!=='全选');
    const selectedDiffTypes = Array.from(document.querySelectorAll('#diffContainer input:checked'))
        .map(cb=>cb.value).filter(v=>v!=='全选');
    const selectedDiffVals = Array.from(document.querySelectorAll('#diffValContainer input:checked'))
        .map(cb=>cb.value).filter(v=>v!=='全选');

    if(selectedDiffTypes.length===0 || selectedDiffVals.length===0){
        alert("请至少选择一个难度类型和难度值！");
        return;
    }

    const filteredSongs = songs.filter(s => selectedPacks.includes(s.musicPack));
    if(filteredSongs.length===0){ alert("没有符合条件的歌曲！"); return; }

    const results = [];
    let attempts = 0;
    while(results.length < num && attempts < num*10){
        attempts++;
        const s = filteredSongs[Math.floor(Math.random()*filteredSongs.length)];
        const availableTypes = selectedDiffTypes.filter(dt => s.difficulties[dt]!=='/');
        if(availableTypes.length===0) continue;

        const selType = availableTypes[Math.floor(Math.random()*availableTypes.length)];
        const selVal = s.difficulties[selType];
        if(!selectedDiffVals.includes(selVal)) continue;

        results.push({song:s, selType, selVal});
    }

    if(results.length===0){alert("没有符合条件的歌曲！"); return;}
    renderResults(results);
}

function renderResults(list){
    const container = document.getElementById('resultContainer');
    container.innerHTML='';
    list.forEach(item=>{
        const s = item.song;
        const card = document.createElement('div');
        card.className='song-card';
        
        const img = document.createElement('img');
        img.src = s.coverUrl || '';
        card.appendChild(img);

        const title = document.createElement('div');
        title.textContent = s.songName;
        card.appendChild(title);

        const diffDiv = document.createElement('div');
        diffDiv.textContent = `${item.selType}: ${item.selVal}`;
        card.appendChild(diffDiv);

        const packDiv = document.createElement('div');
        packDiv.textContent = `曲包: ${s.musicPack}`;
        card.appendChild(packDiv);

        container.appendChild(card);
    });
}
// ==================== 初始化 ====================
function initCheckboxes(){
    createCheckbox(packs,'packContainer');
    createCheckbox(diffTypes,'diffContainer');
    createCheckbox(diffVals,'diffValContainer');
}

loadData();
</script>

</body>
</html>
